---
title: "MALASPINA 18S amplicons analyisis"
author: "Logares R. & Rubinat-Ripoll L."
date: "21/12/2015"
output:
  html_document:
    theme: united
    toc: yes
  pdf_document:
    highlight: zenburn
    toc: yes
---

<!--- INITIALIZATION
```{r, echo=FALSE}
#error hook to kill knitr in case of errors
library(knitr)
knit_hooks$set(error = function(x, options) stop(x))
opts_chunk$set(cache=TRUE, autodep=TRUE)
```
--->

# 1) Data overview

Table dimensions and content outline:

``` {r load_data, echo=FALSE}
#setwd("/genwork/lrubinat")
setwd("/home/laura/Documents/TFM/genwork/data_analysis/MP_18S_SRF_amplicons/MP_18S_amplicons_ss5000")

#read data 
otu_tb18_5000 <- read.table(file="/home/laura/Documents/TFM/home/data/MALASPINA/otus_18S_nohyphen.txt", head=TRUE, fill=TRUE)

#table dimensions and format before setting column names
#dim(otu_tb18_ss5000) # 56116   125
#otu_tb18_ss5000[1:5,1:5]

#row names = OTU name (option A)
row.names(otu_tb18_5000)<-otu_tb18_5000[,1]

#row names = row number (option B)
#rownames(otu_tb18) <- 1:nrow(otu_tb18)

otu_tb18_5000<-otu_tb18_5000[,-1]
otu_tb18_5000[is.na(otu_tb18_5000)]<-0

#dim(otu_tb18_5000) #  56116   124
#otu_tb18_5000[1:5,1:5]

#remove samples with less than 5000 OTUs
otu_tb18_min5000<-otu_tb18_5000[,colSums(otu_tb18_5000) > 5000]

dim(otu_tb18_min5000) #1315 120
otu_tb18_min5000[1:5,1:5]
```

Minimum number of OTUs per station:

```{r reads_per_sample_overview1, echo=1}
min(colSums(otu_tb18_min5000)) 
#8764
```

Maximum number of OTUs per station:

```{r reads_per_sample_overview2, echo=1}
max(colSums(otu_tb18_min5000)) 
# max: 1007852
```

Identification of richest station:

```{r reads_per_sample_overview3, echo=TRUE}
amplicons_per_sample<-colSums(otu_tb18_min5000)
amplicons_per_sample[which(colSums(otu_tb18_min5000)>1000000)]
```

Overall reads per sample:

``` {r reads_per_sample_overview4, echo=FALSE}
plot(sort(colSums(otu_tb18_min5000)), pch=19, xlab="sample", ylab="reads per sample", cex=0.9)
```


# 2) Normalization to 5000 reads per sample

Let's normalize the original dataset by randomly subsampling 5000 reads in each station:

``` {r species_richness_rarefaction1, echo=TRUE}
library(vegan)
otu_tb18_min5000_t<-t(otu_tb18_min5000)
otu_tb18_t_ss5000<-rrarefy(otu_tb18_min5000_t, 5000)
```

The normalized table shows the following dimensions and format:

```{r species_richness_rarefaction2, echo=FALSE}
dim(otu_tb18_t_ss5000)
otu_tb18_t_ss5000[1:5,1:5]
```

Its content fits on the expected normalization values (5000 reads per station):

``` {r species_richness_rarefaction3, echo=TRUE}
rowSums(otu_tb18_t_ss5000)
```

Let's check out how many OTUs don't appear in the new table:

```{r species_richness_rarefaction4, echo=1:5}
length(which(colSums(otu_tb18_t_ss5000)==0)) 
```

There are 30725 OTUs that don't show any occurrence in the normalized data. Let's remove them from the table and take a look at its final dimensions:

```{r species_richness_rarefaction5, echo=1:3}
otu_tb18_t_ss5000_no_cero<-otu_tb18_t_ss5000[,-(which(colSums(otu_tb18_t_ss5000)==0))]
dim(otu_tb18_t_ss5000_no_cero)

#The final dimensions of the normalized table are 124 x 23264.
#23264+32852 = 56116
```

Datasets summary:

otu_tb18_min5000_t --> 123 56116

otu_tb18_t_ss5000_no_cero --> 123 25358


# 3) General community analysis

## 3.1) Richness and evenness (Shannon index)

```{r shannon_index1, echo=FALSE}
otu_tb18_ss5000_div <- diversity(otu_tb18_t_ss5000_no_cero, index="shannon")
```

Most of the samples take Shannon Index values between 5 and 6:
```{r shannon_index2, echo=FALSE}
boxplot(otu_tb18_ss5000_div, pch=19, main="Shannon's index of diversity")
plot(sort(otu_tb18_ss5000_div), pch=19, main="Shannon's index of diversity")
```

## 3.2) Richness: OTU number

```{r richness_otu_no1, echo=FALSE}
OTUs_per_sample_18S_ss5000<-specnumber(otu_tb18_t_ss5000_no_cero)
```

Lowest number of OTUs per sample:
```{r richness_otu_no2, echo=FALSE}
min(OTUs_per_sample_18S_ss5000)
```

Maximum number of OTUs per sample:
```{r richness_otu_no3, echo=FALSE}
max(OTUs_per_sample_18S_ss5000)
```

In most of the samples, we can identify between 1000 and 1300 OTUs:
```{r richness_otu_no4, echo=TRUE}
plot(sort(OTUs_per_sample_18S_ss5000), pch=19)
boxplot(OTUs_per_sample_18S_ss5000, pch=19)
```

## 3.3) Index of evenness

### 3.3.1) Pielou's index

```{r pielou_index_of_evenness1, echo=TRUE}
pielou_evenness_18S_ss5000 <- otu_tb18_ss5000_div/log(OTUs_per_sample_18S_ss5000)
```

Most of the samples get values between 0.8 and 0.9, meaning that the numerical composition of different OTUs in a sample is highly similar:

```{r pielou_index_of_evenness2, echo=TRUE}
plot(sort(pielou_evenness_18S_ss5000), pch=19)
boxplot(pielou_evenness_18S_ss5000, pch=19)
```

The OTU_2, with 26077 reads, is the most abundant in the overall dataset:
```{r OTUs_overall_abundance, echo=TRUE}
head(sort(colSums(otu_tb18_t_ss5000_no_cero), decreasing=T), n=10L)
```

Most of the OTUs show very few occurrences:
```{r OTUs_overall_abundance2, echo=TRUE}
plot(log(sort(colSums(otu_tb18_t_ss5000_no_cero), decreasing=T)), pch=19)
```

<!---
### 3.3.2) Sads
library(sads)
?sads
--->

## 3.4) Abundance Models
### 3.4.1) Rank-Abundance or Dominance/Diversity Model ("radfit")

In the following plot we can appreciate that, as expected, our OTUs abundance distribution fits relativelly close to log-normal model. 

```{r radfit, echo=FALSE}
#?radfit
#otu_tb18_t[1:5,1:5]

otu_tb18_min5000_radfit<-radfit(colSums(otu_tb18_min5000_t))
plot(otu_tb18_min5000_radfit)
```

### 3.4.2) Preston's Lognormal Model

Preston's lognormal model fit into species frequencies groups (we're missing ~3,204 species):
```{r preston_model1, echo=T}
otu_tb18_min5000_prestonfit<-prestonfit(colSums(otu_tb18_min5000_t))
plot(otu_tb18_min5000_prestonfit, main="Pooled species")

veiledspec(otu_tb18_min5000_prestonfit)
```

Preston's lognormal model fit without pooling data into groups (we're missing ~3,029 species):
```{r preston_model2, echo=4}
otu_tb18_min5000_dist_all<-prestondistr(colSums(otu_tb18_min5000_t))
plot(otu_tb18_min5000_prestonfit, main="All malaspina")
lines(otu_tb18_min5000_dist_all, line.col="blue3")

veiledspec(otu_tb18_min5000_dist_all)
```

## 3.5) Rarefaction curve

```{r rarefraction_curve, echo=TRUE}
#?rarecurve

#str(colSums(otu_tb18_t))

#otus_tb18_colsums<-colSums(otu_tb18_t)

#str(otus_tb18_colsums)
#otu_tb18_colsums<-as.matrix(otu_tb18_colsums)

#otu_tb18_colsums<-t(otu_tb18_colsums)

#otu_tb18_colsums[,1:3]

#rarecurve(otu_tb18_colsums, step = 1, 50000, xlab = "Sample Size", ylab = "OTUs", label = TRUE)

#rarecurve(colSums(otu_tb18_t), step = 1, 50000, xlab = "Sample Size", ylab = "OTUs", label = TRUE)
```

## 3.6) Beta diversity

### 3.6.1) Dissimilarity matrix using Bray-Curtis index:

The index Bray-Curtis allows us to quantify the differences between samples according to the composition and relative abundance of their OTUs. In our dataset, most of the samples pairs take dissimilarity values between 0.7 and 0.8, meaning that their composition is substantially different.

```{r beta_div1, echo=FALSE}
#?vegdist
otu_tb18_t_ss5000_no_cero.bray<-vegdist(otu_tb18_t_ss5000_no_cero, method="bray")
boxplot(otu_tb18_t_ss5000_no_cero.bray, main="Bray-Curtis dissimilarity matrix")
```

### 3.6.2) Hierarchical clustering

The only relatively evident cluster we can distinguish in the dendogram stands out in the very left side of the plot and contains 7 stations.

```{r beta_div2, echo=FALSE}
#UPGMA
otu_tb18_t_ss5000_no_cero.upgma<-hclust(otu_tb18_t_ss5000_no_cero.bray, "average")
plot(otu_tb18_t_ss5000_no_cero.upgma, cex=.35, main="Samples Hierarchical Clustering")
```

### 3.6.3) Non-metric multidimensional scaling

We can identify a prominent group in the middle right side of the NMDS plot and a few isolated samples in the left edge of the plot. The stress parameter takes a value below 0.3 (0.2049139), suggesting that the plot is acceptable. 

```{r monoNMDS, echo=F}
#NMDS
otu_tb18_t_ss5000_no_cero.nmds<-monoMDS(otu_tb18_t_ss5000_no_cero.bray)
otu_tb18_t_ss5000_no_cero.nmds
plot(otu_tb18_t_ss5000_no_cero.nmds, main="monoMDs method")
```

When implementing a most robut function for computing NMDS plots, the result is quiet the same:

```{r metaNMDS, echo=F}
otu_tb18_t_ss5000_no_cero.meta_nmds<-metaMDS(otu_tb18_t_ss5000_no_cero.bray)
plot(otu_tb18_t_ss5000_no_cero.meta_nmds, main="metaMDS method")
```

# 4) Geographical analysis

```{r load_geo_data, echo=F, results="hide", message=F}
#load geographical ubication of stations and sort according to otu_tb18 stations sequence.
MP_geo_18S_ss5000<-read.table(file="/home/laura/Documents/TFM/home/data/MALASPINA/mp_surface_ubication.txt", sep="\t", header=T)

row.names(MP_geo_18S_ss5000)<-MP_geo_18S_ss5000[,1]

MP_geo_18sorted_ss5000<-MP_geo_18S_ss5000[row.names(otu_tb18_t_ss5000_no_cero),]
dim(MP_geo_18sorted_ss5000)
MP_geo_18sorted_ss5000[1:5,1:5]
otu_tb18_t_ss5000_no_cero[1:5,1:5]

#read lat-long in decimal degrees and translate into distance in km.
library(fossil)

#select only columns containing info about station, latitude and longitude.
MP_geo_18sorted_ss5000_v2<-create.lats(MP_geo_18sorted_ss5000, loc="sample", long="long", lat="lat")
head(MP_geo_18sorted_ss5000)

#create a distance matrix (lower triangle) between a list of points.
geo_distances_MP_18S_ss5000<-earth.dist(MP_geo_18sorted_ss5000_v2, dist = TRUE)
head(geo_distances_MP_18S_ss5000)
dim(geo_distances_MP_18S_ss5000)

geo_distances_MP_18S_ss5000<-as.matrix(geo_distances_MP_18S_ss5000)
dim(geo_distances_MP_18S_ss5000)

#geo distances dataset ready to use "geo_distances_MP_euks"
```

Working datasets:

1) Community matrix: otu_tb18_t_ss5000_no_cero
```{r working_datasets1, echo=T}
dim(otu_tb18_t_ss5000_no_cero)
otu_tb18_t_ss5000_no_cero[1:5, 1:5]
```

2) Community Bray-Curtis: otu_tb18_t_ss5000_no_cero.bray
```{r working_datasets2, echo=T}
dim(otu_tb18_t_ss5000_no_cero.bray)
otu_tb18_t_ss5000_no_cero.bray<-as.matrix(otu_tb18_t_ss5000_no_cero.bray)
```

3) Stations distances in km: geo_distances_mala_euks
```{r working_datasets3, echo=T}
dim(geo_distances_MP_18S_ss5000)
```

Communities quickly change their composition across geographical distances:

```{r working_datasets4, echo=T}
plot(geo_distances_MP_18S_ss5000, otu_tb18_t_ss5000_no_cero.bray, pch=19, cex=0.4, xlab="Geopgraphic distances", ylab="Bray-Curtis dissimilarities")
```

## 4.1) Mantel correlograms

Mantel statistic is -significantlly- so low, meaning that the correlation between samples dissimilarity and geographical distances is weak.

```{r mantel_correlogram1, echo=T}
mantel(geo_distances_MP_18S_ss5000, otu_tb18_t_ss5000_no_cero.bray)
```

Maximum distance between samples:
```{r mantel_correlogram2, echo=F}
max(geo_distances_MP_18S_ss5000)
```

Minimum distance between samples:
```{r mantel_correlogram3, echo=F}
min(geo_distances_MP_18S_ss5000)
```

Correlograms:
```{r mantel_correlogram4, echo=T}
MP_18s_ss5000_mantel_correl_by_1000km<-mantel.correlog(otu_tb18_t_ss5000_no_cero.bray, D.geo=geo_distances_MP_18S_ss5000, break.pts=seq(0,20000, by=1000))
plot(MP_18s_ss5000_mantel_correl_by_1000km)

MP_18s_ss5000_mantel_correl_by_100km<-mantel.correlog(otu_tb18_t_ss5000_no_cero.bray, D.geo=geo_distances_MP_18S_ss5000, break.pts=seq(0,20000, by=100))
plot(MP_18s_ss5000_mantel_correl_by_100km)
```

# 5) Abundance vs. occurence

```{r OTUs_mean_relative_abund, echo=F}
otu_tb18_t_ss5000_no_cero[1:5,1:5]
otu_tb18_t_ss5000_no_cero_t<-t(otu_tb18_t_ss5000_no_cero)

colSums(otu_tb18_t_ss5000_no_cero_t)

#local abundance percentage
otu_tb18_t_ss5000_no_cero_t.rabund<-otu_tb18_t_ss5000_no_cero_t/5000

colSums(otu_tb18_t_ss5000_no_cero_t.rabund)
otu_tb18_t_ss5000_no_cero_t.rabund[1:5,1:5]

#OTUs mean relative abundance
otu_tb18_t_ss5000_no_cero_t.rabund_means<-rowMeans(otu_tb18_t_ss5000_no_cero_t.rabund) 
otu_tb18_t_ss5000_no_cero_t.rabund_means<-as.data.frame(otu_tb18_t_ss5000_no_cero_t.rabund_means)

head(otu_tb18_t_ss5000_no_cero_t.rabund_means)
```

```{r OTUs_occurence, echo=F}
otu_tb18_t_ss5000_no_cero_t.rabund.occur<-otu_tb18_t_ss5000_no_cero_t.rabund
otu_tb18_t_ss5000_no_cero_t.rabund.occur[otu_tb18_t_ss5000_no_cero_t.rabund.occur>0]<-1
otu_tb18_t_ss5000_no_cero_t.rabund.occur[1:5,1:5] ### presence - absence table

#percentage of occurence in overall stations
otu_tb18_t_ss5000_no_cero_t.rabund_means.occurence_perc<-as.data.frame(100*(rowSums(otu_tb18_t_ss5000_no_cero_t.rabund.occur)/123))

str(otu_tb18_t_ss5000_no_cero_t.rabund_means.occurence_perc)
```

```{r merge_rabund_peroccur, echo=F}
otu_tb18_ss5000_rabund_percoccur<-merge(otu_tb18_t_ss5000_no_cero_t.rabund_means,otu_tb18_t_ss5000_no_cero_t.rabund_means.occurence_perc, by="row.names")

colnames(otu_tb18_ss5000_rabund_percoccur)<-c("OTUs","mean_rabund","perc_occur")
otu_tb18_ss5000_rabund_percoccur[1:5,]

row.names(otu_tb18_ss5000_rabund_percoccur)<-otu_tb18_ss5000_rabund_percoccur[,1]
otu_tb18_ss5000_rabund_percoccur<-otu_tb18_ss5000_rabund_percoccur[,-1]
otu_tb18_ss5000_rabund_percoccur[1:5,]
```

```{r abund_vs_occurence_table, echo=F}
plot(otu_tb18_ss5000_rabund_percoccur$mean_rabund,otu_tb18_ss5000_rabund_percoccur$perc_occur, log="x", pch=19, cex=0.8, xlab="Mean relative abundance", ylab="Percentage of occurence")
abline(h=80, col="red") #occurence higher than 80%
abline(v=0.00001, col="green") #rare OTUs
abline(v=0.001, col="blue") #cosmopolitan OTUs

#Conventional limits:
#Regionally rare     = 0.00001
#Regionally abundant = 0.001
```

```{r abundant_OTUs, echo=T}
#regionally abundant
dim(otu_tb18_ss5000_rabund_percoccur[otu_tb18_ss5000_rabund_percoccur$mean_rabund > 0.001,]) # 157 OTUs
length(row.names(otu_tb18_ss5000_rabund_percoccur[otu_tb18_ss5000_rabund_percoccur$mean_rabund > 0.001,])) # 157 OTUs

#there are 157 regionally abundant OTUs.
(156/23264)*100 # = 0.67% of the OTUs are regionally abundant

row.names(otu_tb18_ss5000_rabund_percoccur[otu_tb18_ss5000_rabund_percoccur$mean_rabund > 0.001,])
```

```{r select_cosmopolitan, echo=T}
otu_tb18_ss5000_rabund_cosm<-otu_tb18_ss5000_rabund_percoccur[otu_tb18_ss5000_rabund_percoccur$mean_rabund > 0.001,]
otu_tb18_ss5000_rabund_poccur_cosm<-otu_tb18_ss5000_rabund_cosm[otu_tb18_ss5000_rabund_cosm$perc_occur > 80,]
otu_tb18_ss5000_cosmop_sorted<-otu_tb18_ss5000_rabund_poccur_cosm[order(otu_tb18_ss5000_rabund_poccur_cosm$perc_occur, otu_tb18_ss5000_rabund_poccur_cosm$mean_rabund, decreasing = T), c(1,2)]

otu_tb18_ss5000_cosmop_sorted
```

```{r rare_OTUs, echo=T}
dim(otu_tb18_ss5000_rabund_percoccur[otu_tb18_ss5000_rabund_percoccur$mean_rabund < 0.00001 & otu_tb18_ss5000_rabund_percoccur$mean_rabund >0,]) # 17450 OTUs
length(row.names(otu_tb18_ss5000_rabund_percoccur[otu_tb18_ss5000_rabund_percoccur$mean_rabund < 0.00001 & otu_tb18_ss5000_rabund_percoccur$mean_rabund >0 ,])) # 17450 OTUs
 
(19383/25358)*100 # = 76.44% of the OTUs are regionally rare

dim(otu_tb18_ss5000_rabund_percoccur) # 25358 Total OTUs
```

```{r otu_col_chech, echo = T}
dim(otu_tb18_min5000)
otu_tb18_min5000[1:5,1:5]
```

